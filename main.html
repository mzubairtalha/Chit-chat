<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chit Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="kaiads.v5.min.js"></script> 
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  background-color: #efeae2;
  color: #111b21;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header, header1 {
  background: #075e54;
  color: #fff;
  text-align: center;
  padding: 10px 15px;
  font-size: 18px;
  font-weight: 500;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 10;
}

header1 {
  font-size: 20px;
}

.navItem {
  display: block;
  width: 90%;
  margin: 10px auto;
  padding: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #d1d7db;
  background: #fff;
  transition: border 0.2s ease;
}

.navItem:focus {
  border: 2px solid #25d366;
  outline: none;
}

button {
  background: #25d366;
  color: #fgff; /* Fixed typo from #hfff to #fff */
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight: 500;
  padding: 10px 20px;
  width: 80%;
  border-radius: 8px;
  margin: 10px auto;
  transition: background 0.2s ease;
  text-align: center;
}

button:hover {
  background: #20b85a;
}

#loginPage, #mainPage, #chatPage {
  flex: 1;
  overflow: auto;
  display: none;
}

#loginPage.active, #mainPage.active, #chatPage.active {
  display: flex;
  flex-direction: column;
}

#loginPage {
  justify-content: center;
  align-items: center;
  background-color: #fff;
  height: 100vh;
  padding-top: 60px;
}

#loginContainer {
  width: 90%;
  text-align: center;
}

#mainPage {
  padding-top: 60px;
}

#privateChatList {
  padding: 10px;
  text-align: center;
}

#privateChatList h4 {
  margin-bottom: 10px;
}

.chat-item {
  padding: 12px;
  background: #fff;
  border-bottom: 1px solid #d1d7db;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.2s ease;
}

.chat-item:hover {
  background: #f0f0f0;
}

#chatHeader {
  font-size: 18px;
  padding: 10px 15px;
  background: #075e54;
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#chatBox {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png') repeat;
  background-size: contain;
}

.message-container {
  display: flex;
  flex-direction: column;
  margin: 12px 0; /* Increased margin for spacing between messages */
  max-width: 70%;
  position: relative;
}

.sent-container {
  align-self: flex-end;
}

.received-container {
  align-self: flex-start;
}

.message {
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  position: relative;
  word-wrap: break-word;
  display: flex;
  flex-direction: column;
}

.sent {
  background: #dcf8c6;
  color: #111b21;
}

.received {
  background: #fff;
  color: #111b21;
}

.message:focus {
  outline: 2px solid #25d366;
  box-shadow: none;
}

.seen-timestamp, .received-timestamp {
  font-size: 10px;
  color: #667781;
  margin-top: 2px;
  align-self: flex-end;
}

.reaction {
  font-size: 12px;
  position: absolute;
  bottom: -22px; /* Position below the message */
  right: 5px;
  background: #fff;
  padding: 2px 6px;
  border-radius: 12px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  z-index: 5; /* Ensure it stays visible */
}

.reply-preview {
  font-size: 12px;
  background: rgba(0, 0, 0, 0.05);
  padding: 6px;
  border-radius: 6px;
  margin-bottom: 4px;
  color: #111b21;
  border-left: 3px solid #25d366;
}

.reply-input-preview {
  font-size: 12px;
  background: rgba(0, 0, 0, 0.05);
  padding: 6px;
  border-radius: 6px;
  margin-bottom: 4px;
  color: #111b21;
  border-left: 3px solid #25d366;
  display: none;
}

.seen-dot {
  width: 8px;
  height: 8px;
  background-color: #34b7f1;
  border-radius: 50%;
  position: absolute;
  bottom: 2px;
  right: 2px;
  display: none;
}

#messageInputContainer {
  display: flex;
  align-items: center;
  padding: 10px;
  background: #f0f2f5;
  border-top: 1px solid #d1d7db;
  gap: 10px;
}

#imageButton {
  width: 30px;
  height: 30px;
  background: url('https://cdn-icons-png.flaticon.com/512/1828/1828925.png') no-repeat center;
  background-size: 20px;
  border: none;
  cursor: pointer;
}

#videoButton {
  width: 30px;
  height: 30px;
  background: url('https://cdn-icons-png.flaticon.com/512/1828/1828925.png') no-repeat center;
  background-size: 20px;
  border: none;
  cursor: pointer;
}

#imageButton:focus, #videoButton:focus {
  outline: 2px solid #25d366;
}

#messageInput {
  flex: 1;
  padding: 10px;
  font-size: 14px;
  border: none;
  border-radius: 20px;
  background: #fff;
  color: #111b21;
}

#sendButton {
  width: 30px;
  height: 30px;
  background: url('https://cdn-icons-png.flaticon.com/512/60/60525.png') no-repeat center;
  background-size: 20px;
  border: none;
  cursor: pointer;
}

#sendButton:focus {
  outline: 2px solid #25d366;
}

#softKeysContainer {
  height: 1.5rem;
  line-height: 1.5rem;
  width: 100%;
  background: #075e54;
  position: fixed;
  bottom: 0;
  display: none;
}

#softKeysContainer.active {
  display: block;
}

#softkey-left, #softkey-center, #softkey-right {
  font-size: 14px;
  color: #fff;
}

#softkey-left {
  float: left;
  margin-left: 10px;
}

#softkey-right {
  float: right;
  margin-right: 10px;
}

.message img {
  max-width: 100%;
  height: 150px;
  border-radius: 8px;
  margin-top: 4px;
}

.message video {
  max-width: 100%;
  height: 150px;
  border-radius: 8px;
  margin-top: 4px;
}

.emoji-container {
  display: none;
  position: absolute;
  top: -40px; /* Position above the message */
  right: 0;
  background: #fff;
  border: 1px solid #d1d7db;
  border-radius: 8px;
  padding: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 100; /* Higher z-index to stay above messages */
}

.emoji {
  display: inline-block;
  padding: 5px;
  font-size: 18px;
  cursor: pointer;
}

.emoji:focus {
  outline: 2px solid #25d366;
  background: #f0f2f5;
}

.action-container {
  display: none;
  position: absolute;
  bottom: -60px;
  right: 0;
  background: #fff;
  border: 1px solid #d1d7db;
  border-radius: 8px;
  padding: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 100;
}

.action-button {
  display: block;
  padding: 6px 10px;
  font-size: 12px;
  color: #111b21;
  border-radius: 4px;
  cursor: pointer;
  margin: 2px 0;
}

.delete-for-me {
  color: #d32f2f;
}

.delete-for-everyone {
  color: #d32f2f;
}

.action-button:focus {
  background: #f0f2f5;
  outline: 2px solid #25d366;
}

.last-seen {
  font-size: 10px;
  color: #d1d7db;
  margin-top: 2px;
}

.deleted-message {
  background: #f0f2f5;
  color: #667781;
  font-style: italic;
}

.blocked-message {
  background: #ffebee;
  color: #d32f2f;
  font-style: italic;
  text-align: center;
  width: 100%;
  margin: 10px 0;
  padding: 10px;
  border-radius: 8px;
}

.typing-indicator {
  font-size: 12px;
  color: #25d366;
  font-style: italic;
  text-align: center;
  width: 100%;
  margin: 5px 0;
}

.dropdown-menu {
  display: none;
  position: fixed;
  bottom: 20px;
  left: 10px;
  background: #fff;
  border: 1px solid #d1d7db;
  border-radius: 8px;
  padding: 5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.dropdown-item {
  padding: 6px 10px;
  font-size: 14px;
  color: #111b21;
  cursor: pointer;
  border-radius: 4px;
}

.dropdown-item:focus {
  background: #f0f2f5;
  outline: 2px solid #25d366;
}

.custom-alert {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #25d366;
  border-radius: 8px;
  padding: 20px;
  z-index: 10000;
  text-align: center;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.custom-alert-header {
  background: #075e54;
  color: #fff;
  padding: 10px;
  font-weight: 500;
  border-radius: 8px 8px 0 0;
  margin: -20px -20px 10px -20px;
}

.custom-alert .navItem {
  width: 100%;
}

.button-container {
  display: flex;
  justify-content: space-around;
  margin-top: 10px;
}

.custom-notification {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: #075e54;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  z-index: 10001;
  text-align: center;
  font-size: 14px;
  display: none;
}

.custom-notification.active {
  display: block;
}

.play-icon {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 40px;
  height: 40px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  pointer-events: none;
}

.play-icon::before {
  content: "▶";
  position: absolute;
  top: 50%;
  left: 55%;
  transform: translate(-50%, -50%);
  color: #fff;
  font-size: 20px;
}

.download-progress, .upload-progress {
  font-size: 12px;
  color: #667781;
  margin-top: 5px;
}

video[style*="position: fixed"],
img[style*="position: fixed"] {
  object-fit: contain;
  max-width: 90%;
  max-height: 90vh;
}

video {
  max-width: 100%;
  max-height: 150px;
}
  </style>
</head>
<body>
  <div id="loginPage" class="active">
    <header1>Chit Chat - Login</header1>
    <div id="loginContainer">
      <input type="text" id="usernameInput" class="navItem" placeholder="Enter your name" tabindex="1" />
      <input type="password" id="passwordInput" class="navItem" placeholder="Enter your password" tabindex="2" />
      <button id="signInButton" class="navItem" tabindex="3">Sign In</button>
    </div>
  </div>
<div id="footer-status" style="position: fixed; bottom: 0; width: 100%; text-align: center;">Offline</div>
  <div id="mainPage">
    <header>Private Chat</header>
    <input type="text" id="searchInput" class="navItem" placeholder="Search for a user" tabindex="1" />
    <button id="searchButton" class="navItem" tabindex="2">Search</button>
    <button id="worldChatButton" class="navItem" tabindex="3" onclick="navigateTo('world_chat.html')">World Chat</button>
    <button id="groupChatButton" class="navItem" tabindex="4" onclick="navigateTo('groups.html')">Group Chat</button>
    <button id="changeBackgroundButton" class="navItem" tabindex="5">Change Chat Background</button>
    <button id="changeThemeButton" class="navItem" tabindex="6">Change Theme</button>
    <div id="privateChatList">
      <h4>Your Private Chats:</h4>
    </div>
  </div>

  <div id="chatPage">
    <header id="chatHeader">Chat</header>
    <div id="chatBox">
      <div class="empty-message"></div>
    </div>
    <div id="messageInputContainer">
      <div id="replyInputPreview" class="reply-input-preview"></div>
      <div style="display: flex; width: 100%; gap: 8px;">
        <button id="imageButton" class="navItem" tabindex="3"></button>
        <input type="text" id="messageInput" class="navItem" placeholder="Enter your message" tabindex="5" />
        <button id="sendButton" class="navItem" tabindex="6"></button>
      </div>
    </div>
  </div>
  <div id="softKeysContainer">
    <div id="softkey-left"></div>
    <div id="softkey-center"></div>
    <div id="softkey-right">Back</div>
  </div>

  <!-- Custom Notification Container -->
  <div id="notificationContainer" class="custom-notification"></div>

  <!-- Dropdown Menu Container -->
  <div id="dropdownMenu" class="dropdown-menu"></div>
<script>
    var firebaseConfig = {
      apiKey: "AIzaSyCcPZRtjWHfW-5fTNsXeEfT7IrAx7O2vRM",
      authDomain: "chit-chat-359a4.firebaseapp.com",
      projectId: "chit-chat-359a4",
      storageBucket: "chit-chat-359a4.appspot.com",
      messagingSenderId: "941229772449",
      appId: "1:941229772449:web:f0d6c439397e55dc076ae0",
      measurementId: "G-TJHQSFCVR0"
    };

    firebase.initializeApp(firebaseConfig);

    var username = localStorage.getItem("username");
    var password = localStorage.getItem("password");
    var loginPage = document.getElementById("loginPage");
    var mainPage = document.getElementById("mainPage");
    var chatPage = document.getElementById("chatPage");
    var chatHeader = document.getElementById("chatHeader");
    var chatBox = document.getElementById("chatBox");
    var privateChatList = document.getElementById("privateChatList");
    var messageInput = document.getElementById("messageInput");
    var imageButton = document.getElementById("imageButton");
    var sendButton = document.getElementById("sendButton");
    var changeBackgroundButton = document.getElementById("changeBackgroundButton");
    var changeThemeButton = document.getElementById("changeThemeButton");
    var softKeysContainer = document.getElementById("softKeysContainer");
    var softkeyLeft = document.getElementById("softkey-left");
    var softkeyRight = document.getElementById("softkey-right");
    var signInButton = document.getElementById("signInButton");
    var usernameInput = document.getElementById("usernameInput");
    var passwordInput = document.getElementById("passwordInput");
    var notificationContainer = document.getElementById("notificationContainer");
    var dropdownMenu = document.getElementById("dropdownMenu");
    var replyInputPreview = document.getElementById("replyInputPreview");
    var currentChatType = null;
    var messages = [];
    var chatRef = null;
    var otherChatRef = null;
    var processedMessages = new Set();
    var pressCount = 0;
    var currentEmojiContainer = null;
    var currentActionContainer = null;
    var shownAlerts = new Set();
    var isAlertActive = false;
    var isBlockedByUser = false;
    var isDropdownVisible = false;
    var lastFocusedElement = null;
    var typingTimeout = null;
    var currentOpenChat = null;
    var replyingToMessageId = null;

    document.addEventListener("DOMContentLoaded", function () {
      var savedBackground = localStorage.getItem("chatBackground");
      var savedTheme = localStorage.getItem("chatTheme");
      if (savedBackground) {
        chatBox.style.backgroundImage = "url(" + savedBackground + ")";
      }
      if (savedTheme) {
        document.body.className = savedTheme;
      }
      if (username && password) {
        authenticateUser(username, password);
        mainPage.classList.add("active");
        loginPage.classList.remove("active");
        softKeysContainer.style.display = "block";
        softkeyLeft.innerHTML = "";
        softkeyRight.innerHTML = "Back";
        document.getElementById("searchInput").focus();
        loadNotifications();
      } else {
        loginPage.classList.add("active");
        softkeyLeft.innerHTML = "";
        softkeyRight.innerHTML = "";
        usernameInput.focus();
      }
    });

    function showCustomAlert(message, callback) {
      isAlertActive = true;
      var alertBox = document.createElement("div");
      alertBox.className = "custom-alert";
      alertBox.innerHTML = '<div class="custom-alert-header">Chit Chat</div><p>' + message + '</p><button id="alertOkButton" class="navItem">OK</button>';
      document.body.appendChild(alertBox);

      var okButton = document.getElementById("alertOkButton");
      okButton.focus();
      okButton.onclick = function () {
        document.body.removeChild(alertBox);
        isAlertActive = false;
        if (callback) callback(true);
      };

      okButton.onkeydown = function (e) {
        if (e.key === "Enter") okButton.click();
      };
    }

    function showCustomPrompt(message, callback, validOptions) {
      isAlertActive = true;
      var alertBox = document.createElement("div");
      alertBox.className = "custom-alert";
      alertBox.innerHTML = '<div class="custom-alert-header">Chit Chat</div><p>' + message + '</p><input type="text" id="promptInput" class="navItem" /><button id="promptOkButton" class="navItem">OK</button>';
      document.body.appendChild(alertBox);

      var input = document.getElementById("promptInput");
      var okButton = document.getElementById("promptOkButton");
      input.focus();

      okButton.onclick = function () {
        var value = input.value.trim();
        if (validOptions && (!value || validOptions.indexOf(value) === -1)) {
          showCustomAlert("Please select one option.", function () {
            input.focus();
          });
          return;
        }
        document.body.removeChild(alertBox);
        isAlertActive = false;
        callback(value);
      };

      input.onkeydown = function (e) {
        if (e.key === "Enter") okButton.click();
      };

      input.onkeydown = function (e) {
        if (e.key === "ArrowDown") {
          okButton.focus();
        }
      };

      okButton.onkeydown = function (e) {
        if (e.key === "ArrowUp") {
          input.focus();
        }
      };
    }

    function showConfirmPrompt(message, callback) {
      isAlertActive = true;
      var alertBox = document.createElement("div");
      alertBox.className = "custom-alert";
      alertBox.innerHTML = '<div class="custom-alert-header">Chit Chat</div><p>' + message + '</p><div class="button-container"><button id="confirmOkButton" class="navItem">OK</button><button id="confirmCancelButton" class="navItem">Cancel</button></div>';
      document.body.appendChild(alertBox);

      var okButton = document.getElementById("confirmOkButton");
      var cancelButton = document.getElementById("confirmCancelButton");
      okButton.focus();

      okButton.onclick = function () {
        document.body.removeChild(alertBox);
        isAlertActive = false;
        callback(true);
      };

      cancelButton.onclick = function () {
        document.body.removeChild(alertBox);
        isAlertActive = false;
        callback(false);
      };

      okButton.onkeydown = function (e) {
        if (e.key === "Enter") okButton.click();
        if (e.key === "ArrowRight") cancelButton.focus();
      };

      cancelButton.onkeydown = function (e) {
        if (e.key === "Enter") cancelButton.click();
        if (e.key === "ArrowLeft") okButton.focus();
      };
    }

    function showNotification(message) {
      notificationContainer.textContent = message;
      notificationContainer.classList.add("active");
      setTimeout(function () {
        notificationContainer.classList.remove("active");
      }, 10000);
    }

    function loadNotifications() {
      var notificationsRef = firebase.database().ref("notifications");
      notificationsRef.orderByChild("timestamp").limitToLast(1).on("child_added", function (snapshot) {
        var notificationData = snapshot.val();
        if (notificationData && notificationData.message) {
          showNotification(notificationData.message);
        }
      });
    }

    signInButton.onclick = function () {
      var enteredUsername = usernameInput.value.trim();
      var enteredPassword = passwordInput.value.trim();
      if (!enteredUsername || !enteredPassword) {
        showCustomAlert("Please enter both username and password.");
        return;
      }
      authenticateUser(enteredUsername, enteredPassword);
    };

    usernameInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        passwordInput.focus();
      }
    });

    passwordInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        signInButton.focus();
        signInButton.click();
      }
    });

    function navigateTo(url) {
      window.location.href = url;
    }

    function registerPushNotifications() {
      if ('navigator.mozApps' in window) {
        var request = navigator.mozApps.getSelf();
        request.onsuccess = function() {
          var app = this.result;
          if (app) {
            navigator.push = navigator.push || {};
            var reg = navigator.push.register();
            reg.onsuccess = function(e) {
              var endpoint = e.result;
              localStorage.setItem("pushEndpoint", endpoint);
              console.log("Push endpoint registered:", endpoint);
            };
          }
        };
      }
    }

    function sendPushNotification(message, from) {
      if (Notification.permission === "granted") {
        new Notification("New message from " + from, {
          body: message,
          icon: 'icons/icon56x56.png'
        });
      }
    }

    function showKaiAd() {
      getKaiAd({
        publisher: 'da08737d-861e-4ebe-bbbb-8fb90d004d39',
        app: 'Chit_Chat',
        slot: 'Chit_Chat__slot',
        onerror: function(err) { console.error('Custom catch:', err); },
        onready: function(ad) {
          var previouslyFocusedElement = document.activeElement;
          ad.call('display');
          ad.on('display', function() { softKeysContainer.style.display = (chatPage.classList.contains("active") || mainPage.classList.contains("active")) ? "block" : "none"; });
          ad.on('close', function() {
            if (previouslyFocusedElement) previouslyFocusedElement.focus();
            softKeysContainer.style.display = (chatPage.classList.contains("active") || mainPage.classList.contains("active")) ? "block" : "none";
          });
        }
      });
    }

    function authenticateUser(enteredUsername, enteredPassword) {
      firebase.database().ref("users/" + enteredUsername).once("value", function (snapshot) {
        if (snapshot.exists()) {
          var userData = snapshot.val();
          if (userData.password === enteredPassword) {
            username = enteredUsername;
            password = enteredPassword;
            localStorage.setItem("username", username);
            localStorage.setItem("password", password);
            loginPage.classList.remove("active");
            mainPage.classList.add("active");
            softKeysContainer.style.display = "block";
            softkeyLeft.innerHTML = "";
            softkeyRight.innerHTML = "Back";
            loadPrivateChats();
            setupPresence();
            registerPushNotifications();
            showKaiAd();
            setInterval(showKaiAd, 2 * 60 * 1000);
            document.getElementById("searchInput").focus();
            loadNotifications();
          } else {
            showCustomAlert("Incorrect password. Please try again.", function () {
              passwordInput.value = "";
              passwordInput.focus();
            });
          }
        } else {
          firebase.database().ref("users/" + enteredUsername).set({
            name: enteredUsername,
            password: enteredPassword,
            timestamp: Date.now()
          });
          username = enteredUsername;
          password = enteredPassword;
          localStorage.setItem("username", username);
          localStorage.setItem("password", password);
          loginPage.classList.remove("active");
          mainPage.classList.add("active");
          softKeysContainer.style.display = "block";
          softkeyLeft.innerHTML = "";
          softkeyRight.innerHTML = "Back";
          loadPrivateChats();
          setupPresence();
          registerPushNotifications();
          showKaiAd();
          setInterval(showKaiAd, 2 * 60 * 1000);
          document.getElementById("searchInput").focus();
          loadNotifications();
        }
      });
    }

    function setupPresence() {
      var presenceRef = firebase.database().ref("presence/" + username);
      var connectedRef = firebase.database().ref(".info/connected");

      connectedRef.on("value", function (snap) {
        if (snap.val() === true) {
          presenceRef.set({ online: true, lastSeen: Date.now(), currentChat: currentOpenChat });
          presenceRef.onDisconnect().set({ online: false, lastSeen: Date.now(), currentChat: null });
        }
      });

      setInterval(function() {
        if (username) {
          firebase.database().ref("presence/" + username).update({ lastSeen: Date.now() });
        }
      }, 60000);
    }

    function setTypingStatus(user, isTyping) {
      firebase.database().ref("presence/" + user).update({ typing: isTyping });
    }

    function showTypingIndicator(partnerName) {
      var typingRef = firebase.database().ref("presence/" + partnerName);
      var myPresenceRef = firebase.database().ref("presence/" + username);
      
      typingRef.on("value", function (snap) {
        var data = snap.val();
        myPresenceRef.once("value", function (mySnap) {
          var myData = mySnap.val();
          var typingIndicator = chatBox.querySelector(".typing-indicator");
          
          if (data && myData && data.typing && 
              currentChatType === partnerName && 
              data.currentChat === username && 
              myData.currentChat === partnerName) {
            if (!typingIndicator) {
              typingIndicator = document.createElement("div");
              typingIndicator.className = "typing-indicator";
              typingIndicator.textContent = partnerName + " is typing...";
              chatBox.appendChild(typingIndicator);
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          } else if (typingIndicator) {
            chatBox.removeChild(typingIndicator);
          }
        });
      });
    }

    function isUserBlocked(blocker, blocked) {
      return firebase.database().ref("blocked/" + blocker + "/" + blocked).once("value").then(function (snapshot) {
        return snapshot.exists();
      });
    }

    function blockUser(blocker, blocked) {
      firebase.database().ref("blocked/" + blocker + "/" + blocked).set(true);
      firebase.database().ref("privateChats/" + blocker + "/" + blocked).remove();
      firebase.database().ref("privateChats/" + blocked + "/" + blocker).remove();
    }

    function unblockUser(blocker, blocked) {
      firebase.database().ref("blocked/" + blocker + "/" + blocked).remove();
    }

    function formatLastSeen(timestamp) {
      var now = Date.now();
      var diff = now - timestamp;
      var date = new Date(timestamp);
      var timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      if (diff < 24 * 60 * 60 * 1000) {
        return timeStr;
      } else if (diff < 48 * 60 * 60 * 1000) {
        return "1 day";
      } else {
        return Math.floor(diff / (24 * 60 * 60 * 1000)) + " days";
      }
    }

    function formatSendTime(timestamp) {
      var date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function loadPrivateChats() {
      privateChatList.innerHTML = "<h4>Your Private Chats:</h4>";
      firebase.database().ref("privateChats/" + username).on("child_added", function (snapshot) {
        var partnerName = snapshot.key;
        isUserBlocked(username, partnerName).then(function (blocked) {
          if (!blocked) {
            var userElement = document.createElement("div");
            userElement.className = "user navItem";
            var nameSpan = document.createElement("span");
            nameSpan.textContent = partnerName;
            var unreadSpan = document.createElement("span");
            unreadSpan.style.marginLeft = "5px";
            unreadSpan.style.color = "red";
            unreadSpan.style.fontWeight = "bold";
            userElement.appendChild(nameSpan);
            userElement.appendChild(unreadSpan);
            userElement.tabIndex = 7;

            userElement.onclick = function () {
              openChat(partnerName);
              markMessagesAsSeen(partnerName, userElement);
            };

            userElement.onkeydown = function (e) {
              if (e.key === "Enter") {
                openChat(partnerName);
                markMessagesAsSeen(partnerName, userElement);
              }
            };

            userElement.onfocus = function() {
              softkeyLeft.innerHTML = "Options";
            };

            userElement.onblur = function() {
              if (document.activeElement.className !== "user navItem") {
                softkeyLeft.innerHTML = "";
              }
            };

            privateChatList.appendChild(userElement);

            function updateUnreadCount() {
              var chatRef = firebase.database().ref("privateChats/" + username + "/" + partnerName);
              chatRef.once("value", function (chatSnapshot) {
                var unreadCount = 0;
                chatSnapshot.forEach(function (msgSnapshot) {
                  var data = msgSnapshot.val();
                  if (data.from === partnerName && !data.seen) {
                    unreadCount++;
                  }
                });
                unreadSpan.textContent = unreadCount > 0 ? "(" + unreadCount + ")" : "";
                updateUserColor(partnerName, userElement, unreadCount);
              });
            }

            var chatRef = firebase.database().ref("privateChats/" + username + "/" + partnerName);
            chatRef.on("child_added", function (msgSnapshot) {
              var data = msgSnapshot.val();
              if (!data.seen && data.from === partnerName) {
                updateUnreadCount();
                sendPushNotification(data.message || "Media received", partnerName);
              }
            });

            chatRef.on("child_changed", function (msgSnapshot) {
              var data = msgSnapshot.val();
              if (data.from === partnerName) {
                updateUnreadCount();
              }
            });

            firebase.database().ref("presence/" + partnerName).on("value", function (snap) {
              updateUnreadCount();
            });

            updateUnreadCount();
          }
        });
      });
    }

    function updateUserColor(partnerName, userElement, unreadCount) {
      var presenceRef = firebase.database().ref("presence/" + partnerName);
      presenceRef.once("value", function (snap) {
        var isOnline = snap.val() && snap.val().online;
        if (unreadCount > 0) {
          userElement.style.color = "red";
        } else if (isOnline) {
          userElement.style.color = "green";
        } else {
          userElement.style.color = "black";
        }
      });
    }

    function markMessagesAsSeen(partnerName, userElement) {
      var chatRef = firebase.database().ref("privateChats/" + username + "/" + partnerName);
      chatRef.once("value", function (snapshot) {
        snapshot.forEach(function (msgSnapshot) {
          var message = msgSnapshot.val();
          if (message && message.from === partnerName && !message.seen) {
            var seenTimestamp = Date.now();
            chatRef.child(msgSnapshot.key).update({ seen: true, seenTimestamp: seenTimestamp });
            firebase.database().ref("privateChats/" + partnerName + "/" + username + "/" + msgSnapshot.key).update({ seen: true, seenTimestamp: seenTimestamp });
          }
        });
        var unreadSpan = userElement.querySelector("span:nth-child(2)");
        unreadSpan.textContent = "";
        updateUserColor(partnerName, userElement, 0);
      });
    }

    function checkBothSeen(messageId) {
      var senderRef = firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId);
      var receiverRef = firebase.database().ref("privateChats/" + currentChatType + "/" + username + "/" + messageId);
      
      senderRef.once('value', function(senderSnap) {
        receiverRef.once('value', function(receiverSnap) {
          var senderData = senderSnap.val();
          var receiverData = receiverSnap.val();
          var bothSeen = senderData && receiverData && senderData.seen && receiverData.seen;
          var messageElement = document.getElementById("msg-" + messageId);
          if (messageElement) {
            var seenDot = messageElement.parentElement.querySelector(".seen-dot");
            if (bothSeen && senderData.from === username && seenDot) {
              seenDot.style.display = "block";
            } else if (seenDot) {
              seenDot.style.display = "none";
            }
          }
        });
      });
    }

    function updateMessageColor(messageId) {
      checkBothSeen(messageId);
    }

    function checkVideoLimit(callback) {
      var today = new Date().toISOString().split('T')[0];
      var videoCountRef = firebase.database().ref("videoLimits/" + username + "/" + today);
      videoCountRef.once("value", function(snapshot) {
        var count = snapshot.val() || 0;
        if (count < 5) {
          callback(true, count);
        } else {
          callback(false, count);
        }
      });
    }

    function incrementVideoCount() {
      var today = new Date().toISOString().split('T')[0];
      var videoCountRef = firebase.database().ref("videoLimits/" + username + "/" + today);
      videoCountRef.transaction(function(currentCount) {
        return (currentCount || 0) + 1;
      });
    }

    function sendMessage(content, type, replyToId) {
      var messageData = {
        from: username,
        timestamp: Date.now(),
        seen: false
      };

      if (type === "text") {
        messageData.message = content;
      } else {
        messageData.mediaUrl = content;
        messageData.mediaType = type;
      }

      if (replyToId) {
        messageData.replyTo = replyToId;
      }

      if (type === "video") {
        checkVideoLimit(function(allowed, count) {
          if (allowed) {
            var senderChatRef = firebase.database().ref("privateChats/" + username + "/" + currentChatType).push();
            var messageId = senderChatRef.key;
            var receiverChatRef = firebase.database().ref("privateChats/" + currentChatType + "/" + username + "/" + messageId);

            senderChatRef.set(messageData);
            receiverChatRef.set(messageData);
            incrementVideoCount();
          } else {
            showCustomAlert("You have reached your daily limit of 5 videos.");
          }
        });
      } else {
        var senderChatRef = firebase.database().ref("privateChats/" + username + "/" + currentChatType).push();
        var messageId = senderChatRef.key;
        var receiverChatRef = firebase.database().ref("privateChats/" + currentChatType + "/" + username + "/" + messageId);

        senderChatRef.set(messageData);
        receiverChatRef.set(messageData);

        if (type === "text") {
          senderChatRef.update({ seen: false });
        }
      }
      
      replyingToMessageId = null;
      replyInputPreview.style.display = "none";
      replyInputPreview.innerHTML = "";
      messageInput.placeholder = "Enter your message";
    }

    function formatTimestamp(timestamp) {
      var date = new Date(timestamp);
      return date.toLocaleDateString() + " " + date.toLocaleTimeString();
    }

    // IndexedDB Setup
    function openIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("ChitChatDB", 1);

        request.onupgradeneeded = function(event) {
          const db = event.target.result;
          if (!db.objectStoreNames.contains("videos")) {
            db.createObjectStore("videos", { keyPath: "id" });
          }
        };

        request.onsuccess = function(event) {
          resolve(event.target.result);
        };

        request.onerror = function(event) {
          reject(new Error("Failed to open IndexedDB: " + event.target.error));
        };
      });
    }

    function saveVideoToIndexedDB(messageId, base64data) {
      return new Promise((resolve, reject) => {
        openIndexedDB().then(db => {
          const transaction = db.transaction(["videos"], "readwrite");
          const store = transaction.objectStore("videos");
          const request = store.put({ id: "video_" + messageId, data: base64data });

          request.onsuccess = function() {
            resolve();
          };

          request.onerror = function(event) {
            reject(new Error("Failed to save video to IndexedDB: " + event.target.error));
          };
        }).catch(error => {
          reject(error);
        });
      });
    }

    function getVideoFromIndexedDB(messageId) {
      return new Promise((resolve, reject) => {
        openIndexedDB().then(db => {
          const transaction = db.transaction(["videos"], "readonly");
          const store = transaction.objectStore("videos");
          const request = store.get("video_" + messageId);

          request.onsuccess = function(event) {
            if (event.target.result) {
              resolve(event.target.result.data);
            } else {
              resolve(null);
            }
          };

          request.onerror = function(event) {
            reject(new Error("Failed to retrieve video from IndexedDB: " + event.target.error));
          };
        }).catch(error => {
          reject(error);
        });
      });
    }

    function downloadVideo(url, messageId, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.responseType = "blob";

      var progressSpan = document.createElement("span");
      progressSpan.className = "download-progress";
      progressSpan.textContent = "Downloading: 0%";
      var messageElement = document.getElementById("msg-" + messageId);
      if (messageElement) {
        messageElement.appendChild(progressSpan);
      }

      var downloadTimeout = setTimeout(function() {
        xhr.abort();
        progressSpan.textContent = "Download Timeout";
        showCustomAlert("Download timed out. Please try again.");
        console.error("Download timed out for messageId:", messageId);
      }, 30000);

      xhr.onprogress = function(e) {
        if (e.lengthComputable) {
          var percent = Math.round((e.loaded / e.total) * 100);
          progressSpan.textContent = "Downloading: " + percent + "%";
        }
      };

      xhr.onload = function() {
        clearTimeout(downloadTimeout);
        if (xhr.status === 200) {
          var blob = xhr.response;
          var reader = new FileReader();
          
          var readerTimeout = setTimeout(function() {
            progressSpan.textContent = "Conversion Timeout";
            showCustomAlert("Failed to convert video: Conversion timed out.");
            console.error("FileReader timed out for messageId:", messageId);
          }, 20000);

          reader.onloadend = function() {
            clearTimeout(readerTimeout);
            var base64data = reader.result;
            saveVideoToIndexedDB(messageId, base64data).then(() => {
              progressSpan.textContent = "Downloaded";
              console.log("Video downloaded and saved to IndexedDB for messageId:", messageId);
              if (callback) {
                callback(base64data);
              }
            }).catch(error => {
              progressSpan.textContent = "Storage Failed";
              showCustomAlert("Failed to save video: " + error.message);
              console.error("Error saving video to IndexedDB for messageId:", messageId, error);
            });
          };

          reader.onerror = function() {
            clearTimeout(readerTimeout);
            progressSpan.textContent = "Conversion Failed";
            showCustomAlert("Failed to convert video: Conversion error.");
            console.error("Error converting video to base64 for messageId:", messageId, reader.error);
          };

          reader.readAsDataURL(blob);
        } else {
          progressSpan.textContent = "Download Failed";
          showCustomAlert("Failed to download video: HTTP status " + xhr.status);
          console.error("Download failed with status:", xhr.status, "for messageId:", messageId);
        }
      };

      xhr.onerror = function() {
        clearTimeout(downloadTimeout);
        progressSpan.textContent = "Download Failed";
        showCustomAlert("Failed to download video: Network error.");
        console.error("Network error during download for messageId:", messageId);
      };

      xhr.onabort = function() {
        console.error("Download aborted for messageId:", messageId);
      };

      xhr.send();
    }

    function toggleFullScreen(element) {
      if (element.style.position === "fixed") {
        element.style.position = "";
        element.style.top = "";
        element.style.left = "";
        element.style.transform = "";
        element.style.width = element.tagName === "VIDEO" ? "100" : "";
        element.style.height = element.tagName === "VIDEO" ? "120" : "";
        element.style.zIndex = "";
        element.style.backgroundColor = "";
        if (element.tagName === "VIDEO") {
          element.pause();
        }
      } else {
        element.style.position = "fixed";
        element.style.top = "50%";
        element.style.left = "50%";
        element.style.transform = "translate(-50%, -50%)";
        element.style.width = "240px";
        element.style.height = "320px";
        element.style.zIndex = "9999";
        element.style.backgroundColor = "black";
        element.style.objectFit = "contain";
        if (element.tagName === "VIDEO") {
          if (!element.src) {
            showCustomAlert("Cannot play video: Source not set.");
            console.error("Video element has no source:", element);
            return;
          }
          element.addEventListener("canplay", function onCanPlay() {
            element.removeEventListener("canplay", onCanPlay);
            if (typeof element.play === "function") {
              element.play().catch(function(error) {
                console.error("Error playing video in fullscreen:", error);
                showCustomAlert("Failed to play video: " + error.message);
              });
            } else {
              showCustomAlert("Cannot play video: Play function is not available.");
              console.error("Video element.play is not a function:", element);
            }
          }, { once: true });
          element.load(); // Ensure the video is loaded
        }
      }
    }

    function openChat(chatType) {
      currentChatType = chatType;
      currentOpenChat = chatType;
      firebase.database().ref("presence/" + username).update({ currentChat: chatType });
      
      messages = [];
      chatBox.innerHTML = "";
      mainPage.classList.remove("active");
      chatPage.classList.add("active");
      softKeysContainer.style.display = "block";
      softkeyLeft.innerHTML = "";
      softkeyRight.innerHTML = "Back";
      processedMessages.clear();

      if (chatRef) chatRef.off();
      if (otherChatRef) otherChatRef.off();

      chatRef = firebase.database().ref("privateChats/" + username + "/" + chatType);
      otherChatRef = firebase.database().ref("privateChats/" + chatType + "/" + username);

      isUserBlocked(chatType, username).then(function(blocked) {
        isBlockedByUser = blocked;
        updateChatUI();

        var presenceRef = firebase.database().ref("presence/" + chatType);
        presenceRef.on("value", function (snap) {
          var presence = snap.val();
          if (presence && presence.online) {
            chatHeader.innerHTML = "Chat with " + chatType + ' <span class="last-seen">Online</span>';
          } else if (presence) {
            chatHeader.innerHTML = "Chat with " + chatType + ' <span class="last-seen">Last seen: ' + formatLastSeen(presence.lastSeen) + "</span>";
          } else {
            chatHeader.innerHTML = "Chat with " + chatType;
          }
        });

        firebase.database().ref("blocked/" + chatType + "/" + username).on("value", function(snapshot) {
          isBlockedByUser = snapshot.exists();
          updateChatUI();
        });

        chatRef.orderByChild("timestamp").limitToLast(20).on("child_added", function (snapshot) {
          var messageId = snapshot.key;
          if (processedMessages.has(messageId)) return;

          var data = snapshot.val();
          if (data) {
            processedMessages.add(messageId);
            
            var messageContainer = document.createElement("div");
            messageContainer.className = "message-container " + (data.from === username ? "sent-container" : "received-container");
            
            var messageElement = document.createElement("div");
            messageElement.id = "msg-" + messageId;
            messageElement.tabIndex = 8;

            if (data.deleted) {
              messageElement.className = "message deleted-message";
              messageElement.innerHTML = "<span>Message deleted</span>";
            } else if (data.message || data.mediaUrl) {
              messageElement.className = "message " + (data.from === username ? "sent" : "received");
              
              if (data.replyTo) {
                var replyPreview = document.createElement("div");
                replyPreview.className = "reply-preview";
                firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + data.replyTo).once("value", function(replySnap) {
                  var replyData = replySnap.val();
                  if (replyData) {
                    replyPreview.textContent = replyData.message ? replyData.message.substring(0, 20) + "..." : (replyData.mediaType === "image" ? "Image" : "Video");
                  }
                });
                messageElement.appendChild(replyPreview);
              }

              if (data.mediaType === "image") {
                var img = document.createElement("img");
                img.src = data.mediaUrl;
                img.loading = "lazy";
                img.alt = "Loading...";
                img.onload = function () { img.alt = ""; };
                img.onerror = function () { img.alt = "Failed to load image"; };
                img.tabIndex = 9;
                messageElement.appendChild(img);
              } else if (data.mediaType === "video") {
                var video = document.createElement("video");
                getVideoFromIndexedDB(messageId).then(localVideoData => {
                  if (localVideoData) {
                    video.src = localVideoData;
                  } else {
                    video.src = data.mediaUrl;
                  }
                }).catch(error => {
                  console.error("Error retrieving video from IndexedDB for messageId:", messageId, error);
                  video.src = data.mediaUrl; // Fallback to URL
                });
                video.width = 100;
                video.height = 120;
                video.controls = false;
                video.tabIndex = 9;

                var playIcon = document.createElement("div");
                playIcon.className = "play-icon";
                messageElement.appendChild(video);
                messageElement.appendChild(playIcon);

                getVideoFromIndexedDB(messageId).then(localVideoData => {
                  if (!localVideoData) {
                    var statusSpan = document.createElement("span");
                    statusSpan.className = "download-progress";
                    statusSpan.textContent = "Not Downloaded";
                    messageElement.appendChild(statusSpan);
                  }
                });

                video.onerror = function() {
                  console.error("Error loading video for messageId:", messageId);
                  var errorSpan = messageElement.querySelector(".download-progress") || document.createElement("span");
                  errorSpan.className = "download-progress";
                  errorSpan.textContent = "Failed to load video";
                  messageElement.appendChild(errorSpan);
                };
              } else {
                var textSpan = document.createElement("span");
                textSpan.textContent = data.from + ": " + data.message;
                messageElement.appendChild(textSpan);
              }

              if (data.seen && data.seenTimestamp && data.from === username) {
                var timestampSpan = document.createElement("span");
                timestampSpan.className = "seen-timestamp";
                timestampSpan.textContent = "Seen: " + formatTimestamp(data.seenTimestamp);
                messageElement.appendChild(timestampSpan);
              }

              if (data.from !== username) {
                var receivedTimestampSpan = document.createElement("span");
                receivedTimestampSpan.className = "received-timestamp";
                receivedTimestampSpan.textContent = "Received: " + formatSendTime(data.timestamp);
                messageElement.appendChild(receivedTimestampSpan);
              }
            }

            var seenDot = document.createElement("div");
            seenDot.className = "seen-dot";
            messageContainer.appendChild(messageElement);
            messageContainer.appendChild(seenDot);

            if (!data.deleted && data.reaction) {
              var reactionSpan = document.createElement("span");
              reactionSpan.className = "reaction";
              reactionSpan.textContent = data.reaction;
              messageContainer.appendChild(reactionSpan);
            }

            if (!data.deleted) {
              var emojiContainer = document.createElement("div");
              emojiContainer.className = "emoji-container";
              var emojis = ["👍", "😂", "❤", "😢", "😡", "😮"];
              for (var i = 0; i < emojis.length; i++) {
                var span = document.createElement("span");
                span.className = "emoji";
                span.textContent = emojis[i];
                span.tabIndex = 10;
                emojiContainer.appendChild(span);
              }
              messageContainer.appendChild(emojiContainer);

              var actionContainer = document.createElement("div");
              actionContainer.className = "action-container";
              var deleteForMeButton = document.createElement("span");
              deleteForMeButton.className = "action-button delete-for-me";
              deleteForMeButton.textContent = "Delete for Me";
              deleteForMeButton.tabIndex = 11;
              actionContainer.appendChild(deleteForMeButton);

              if (data.from === username) {
                var deleteForEveryoneButton = document.createElement("span");
                deleteForEveryoneButton.className = "action-button delete-for-everyone";
                deleteForEveryoneButton.textContent = "Delete for Everyone";
                deleteForEveryoneButton.tabIndex = 12;
                actionContainer.appendChild(deleteForEveryoneButton);
              }

              if (data.mediaType === "image" || data.mediaType === "video") {
                var fullscreenButton = document.createElement("span");
                fullscreenButton.className = "action-button";
                fullscreenButton.textContent = "Fullscreen";
                fullscreenButton.tabIndex = 13;
                actionContainer.appendChild(fullscreenButton);
              }

              var replyButton = document.createElement("span");
              replyButton.className = "action-button";
              replyButton.textContent = "Reply";
              replyButton.tabIndex = 14;
              actionContainer.appendChild(replyButton);
              
              messageContainer.appendChild(actionContainer);
            }

            chatBox.appendChild(messageContainer);
            messages.push({ id: messageId, element: messageContainer });
            chatBox.scrollTop = chatBox.scrollHeight;

            messageElement.onfocus = function() {
              softkeyLeft.innerHTML = "Options";
            };
            messageElement.onblur = function() {
              if (document.activeElement.className.indexOf("message") === -1 && 
                  document.activeElement.tagName !== "IMG" && 
                  document.activeElement.tagName !== "VIDEO") {
                softkeyLeft.innerHTML = "";
              }
            };

            if (data.mediaType === "image") {
              var img = messageElement.querySelector("img");
              img.onfocus = function() {
                softkeyLeft.innerHTML = "Options";
              };
              img.onblur = function() {
                if (document.activeElement.className.indexOf("message") === -1 && 
                    document.activeElement.tagName !== "IMG" && 
                    document.activeElement.tagName !== "VIDEO") {
                  softkeyLeft.innerHTML = "";
                }
              };
            } else if (data.mediaType === "video") {
              var video = messageElement.querySelector("video");
              video.onfocus = function() {
                softkeyLeft.innerHTML = "Options";
              };
              video.onblur = function() {
                if (document.activeElement.className.indexOf("message") === -1 && 
                    document.activeElement.tagName !== "IMG" && 
                    document.activeElement.tagName !== "VIDEO") {
                  softkeyLeft.innerHTML = "";
                }
              };
            }

            updateMessageColor(messageId);

            if (data.from !== username && !data.seen) {
              firebase.database().ref("presence/" + chatType).once("value", function(snap) {
                var partnerData = snap.val();
                if (partnerData && partnerData.currentChat === username) {
                  chatRef.child(messageId).update({ seen: true, seenTimestamp: Date.now() });
                  otherChatRef.child(messageId).update({ seen: true, seenTimestamp: Date.now() });
                }
              });
            }
          }
        });

        chatRef.on("child_changed", function (snapshot) {
          var messageId = snapshot.key;
          var data = snapshot.val();
          var messageElement = document.getElementById("msg-" + messageId);
          if (messageElement) {
            if (data.deleted) {
              messageElement.className = "message deleted-message";
              messageElement.innerHTML = "<span>Message deleted</span>";
              var reactionSpan = messageElement.parentElement.querySelector(".reaction");
              if (reactionSpan) reactionSpan.parentElement.removeChild(reactionSpan);
              var emojiContainer = messageElement.parentElement.querySelector(".emoji-container");
              if (emojiContainer) emojiContainer.parentElement.removeChild(emojiContainer);
              var actionContainer = messageElement.parentElement.querySelector(".action-container");
              if (actionContainer) actionContainer.parentElement.removeChild(actionContainer);
            } else {
              if (data.reaction) {
                var reactionSpan = messageElement.parentElement.querySelector(".reaction");
                if (!reactionSpan) {
                  reactionSpan = document.createElement("span");
                  reactionSpan.className = "reaction";
                  messageElement.parentElement.appendChild(reactionSpan);
                }
                reactionSpan.textContent = data.reaction;
              }
              if (data.seen && data.seenTimestamp && data.from === username) {
                var timestampSpan = document.getElementById("seen-timestamp-" + messageId);
                if (!timestampSpan) {
                  timestampSpan = document.createElement("span");
                  timestampSpan.id = "seen-timestamp-" + messageId;
                  timestampSpan.className = "seen-timestamp";
                  messageElement.appendChild(timestampSpan);
                }
                timestampSpan.textContent = "Seen: " + formatTimestamp(data.seenTimestamp);
              }
              updateMessageColor(messageId);
            }
          }
        });

        otherChatRef.on("child_changed", function (snapshot) {
          var messageId = snapshot.key;
          var data = snapshot.val();
          var messageElement = document.getElementById("msg-" + messageId);
          if (messageElement) {
            if (data.deleted) {
              messageElement.className = "message deleted-message";
              messageElement.innerHTML = "<span>Message deleted</span>";
              var reactionSpan = messageElement.parentElement.querySelector(".reaction");
              if (reactionSpan) reactionSpan.parentElement.removeChild(reactionSpan);
              var emojiContainer = messageElement.parentElement.querySelector(".emoji-container");
              if (emojiContainer) emojiContainer.parentElement.removeChild(emojiContainer);
              var actionContainer = messageElement.parentElement.querySelector(".action-container");
              if (actionContainer) actionContainer.parentElement.removeChild(actionContainer);
            }
            updateMessageColor(messageId);
          }
        });

        chatRef.on("child_removed", function (snapshot) {
          var messageId = snapshot.key;
          var messageElement = document.getElementById("msg-" + messageId);
          if (messageElement) {
            messageElement.parentElement.removeChild(messageElement.parentElement);
            for (var i = 0; i < messages.length; i++) {
              if (messages[i].id === messageId) {
                messages.splice(i, 1);
                break;
              }
            }
          }
        });

        setTimeout(function () {
          document.getElementById("messageInput").focus();
        }, 100);

        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            sendButton.click();
          }
        });

        messageInput.addEventListener("input", function () {
          if (!isBlockedByUser) {
            setTypingStatus(username, true);
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(function () {
              setTypingStatus(username, false);
            }, 2000);
          }
        });

        sendButton.onclick = function () {
          if (!isBlockedByUser) {
            var message = messageInput.value.trim();
            if (message) {
              sendMessage(message, "text", replyingToMessageId);
              messageInput.value = "";
              setTypingStatus(username, false);
            }
          }
        };

        imageButton.onclick = function () {
          if (!isBlockedByUser) {
            showDropdown(["Image", "Video"], function(index) {
              if (index === 0) {
                sendImage();
              } else if (index === 1) {
                sendVideo();
              }
            });
          }
        };

        showTypingIndicator(chatType);
      });
    }

    function updateChatUI() {
      var messageInputContainer = document.getElementById("messageInputContainer");
      var blockedMessage = chatBox.querySelector(".blocked-message");

      if (isBlockedByUser) {
        messageInputContainer.style.display = "none";
        if (!blockedMessage) {
          var blockedDiv = document.createElement("div");
          blockedDiv.className = "blocked-message";
          blockedDiv.innerHTML = "<span>" + currentChatType + " has blocked you</span>";
          chatBox.appendChild(blockedDiv);
        }
      } else {
        messageInputContainer.style.display = "flex";
        if (blockedMessage) {
          chatBox.removeChild(blockedMessage);
        }
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function uploadFileToCloudinary(file, onProgress, onComplete, onError) {
      var formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "Chitchat");
      formData.append("cloud_name", "dty2ommqq");

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "https://api.cloudinary.com/v1_1/dty2ommqq/upload", true);

      var progressSpan = document.createElement("span");
      progressSpan.className = "upload-progress";
      progressSpan.textContent = "Uploading: 0%";
      chatBox.appendChild(progressSpan);
      chatBox.scrollTop = chatBox.scrollHeight;

      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          var percent = Math.round((e.loaded / e.total) * 100);
          progressSpan.textContent = "Uploading: " + percent + "%";
          if (onProgress) onProgress(percent);
        }
      };

      xhr.onload = function () {
        if (xhr.status === 200) {
          var response = JSON.parse(xhr.responseText);
          progressSpan.textContent = "Uploaded";
          setTimeout(function() {
            chatBox.removeChild(progressSpan);
          }, 2000);
          if (onComplete) onComplete(response.secure_url);
        } else {
          progressSpan.textContent = "Upload Failed";
          if (onError) onError(new Error("Upload failed"));
        }
      };

      xhr.onerror = function () {
        progressSpan.textContent = "Upload Failed";
        if (onError) onError(new Error("Upload failed"));
      };

      xhr.send(formData);
    }

    function sendImage() {
      if ('MozActivity' in window) {
        var activity = new MozActivity({
          name: "pick",
          data: {
            type: ["image/*"]
          }
        });

        activity.onsuccess = function() {
          var file = this.result.blob;
          if (file) {
            uploadFileToCloudinary(file, 
              function(progress) {
                console.log("Image upload progress: " + progress + "%");
              },
              function(url) {
                sendMessage(url, "image", replyingToMessageId);
              },
              function(error) {
                console.error("Error uploading image:", error);
                showCustomAlert("Failed to upload image.");
              }
            );
          }
        };

        activity.onerror = function() {
          console.error("Error picking image:", this.error);
          showCustomAlert("Unable to pick an image.");
        };
      } else {
        var input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = function (e) {
          var file = e.target.files[0];
          if (file) {
            uploadFileToCloudinary(file, 
              function(progress) {
                console.log("Image upload progress: " + progress + "%");
              },
              function(url) {
                sendMessage(url, "image", replyingToMessageId);
              },
              function(error) {
                console.error("Error uploading image:", error);
                showCustomAlert("Failed to upload image.");
              }
            );
          }
        };
        input.click();
      }
    }

    function sendVideo() {
      if ('MozActivity' in window) {
        var activity = new MozActivity({
          name: "pick",
          data: {
            type: ["video/*"]
          }
        });

        activity.onsuccess = function() {
          var file = this.result.blob;
          if (file) {
            uploadFileToCloudinary(file, 
              function(progress) {
                console.log("Video upload progress: " + progress + "%");
              },
              function(url) {
                sendMessage(url, "video", replyingToMessageId);
              },
              function(error) {
                console.error("Error uploading video:", error);
                showCustomAlert("Failed to upload video.");
              }
            );
          }
        };

        activity.onerror = function() {
          console.error("Error picking video:", this.error);
          showCustomAlert("Unable to pick a video.");
        };
      } else {
        showCustomAlert("Video picking is only supported on KaiOS devices with MozActivity.");
      }
    }

    document.getElementById("searchButton").onclick = function () {
      var searchName = document.getElementById("searchInput").value.trim();
      if (!searchName) return showCustomAlert("Please enter a name.");

      firebase.database().ref("users/" + searchName).once("value", function (snapshot) {
        if (snapshot.exists()) {
          Promise.all([
            isUserBlocked(username, searchName),
            isUserBlocked(searchName, username)
          ]).then(function (results) {
            var userBlocked = results[0];
            var blockedByUser = results[1];
            if (userBlocked) {
              showConfirmPrompt("User " + searchName + " is blocked. Do you want to unblock and chat?", function (confirmed) {
                if (confirmed) {
                  unblockUser(username, searchName);
                  showCustomAlert("User unblocked! Starting private chat...", function () {
                    openChat(searchName);
                    updatePrivateChatList(username, searchName);
                  });
                } else {
                  document.getElementById("searchInput").focus();
                }
              });
            } else if (blockedByUser) {
              showCustomAlert(searchName + " has blocked you.", function () {
                document.getElementById("searchInput").focus();
              });
            } else {
              showCustomAlert("User found! Starting private chat...", function () {
                openChat(searchName);
                updatePrivateChatList(username, searchName);
              });
            }
          });
        } else {
          showCustomAlert("User not found.", function () {
            document.getElementById("searchInput").focus();
          });
        }
      });
    };

    changeBackgroundButton.onclick = function () {
      if ('MozActivity' in window) {
        var activity = new MozActivity({
          name: "pick",
          data: {
            type: ["image/*"]
          }
        });

        activity.onsuccess = function() {
          var file = this.result.blob;
          if (file) {
            uploadFileToCloudinary(file, 
              function(progress) {
                console.log("Background upload progress: " + progress + "%");
              },
              function(url) {
                chatBox.style.backgroundImage = "url(" + url + ")";
                chatBox.style.backgroundSize = "cover";
                chatBox.style.backgroundPosition = "center";
                localStorage.setItem("chatBackground", url);
              },
              function(error) {
                console.error("Error uploading background:", error);
                showCustomAlert("Failed to set background.");
              }
            );
          }
        };

        activity.onerror = function() {
          console.error("Error picking background:", this.error);
          showCustomAlert("Unable to pick a background image.");
        };
      } else {
        var input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = function (e) {
          var file = e.target.files[0];
          if (file) {
            uploadFileToCloudinary(file, 
              function(progress) {
                console.log("Background upload progress: " + progress + "%");
              },
              function(url) {
                chatBox.style.backgroundImage = "url(" + url + ")";
                chatBox.style.backgroundSize = "cover";
                chatBox.style.backgroundPosition = "center";
                localStorage.setItem("chatBackground", url);
              },
              function(error) {
                console.error("Error uploading background image:", error);
                showCustomAlert("Failed to set background.");
              }
            );
          }
        };
        input.click();
      }
    };

    changeThemeButton.onclick = function () {
      var themes = [
        "rainbow-theme", "skyway-theme", "night-theme", "forest-theme", "sunset-theme", "ocean-theme",
        "lavender-theme", "galaxy-theme", "neon-theme", "desert-theme", "aurora-theme", "candy-theme",
        "neon-glowing-theme", "cosmic-dust-theme", "tropical-vibe-theme", "electric-pulse-theme",
        "mystic-dawn-theme", "firestorm-theme", "glacial-glow-theme", "retro-wave-theme", "golden-horizon-theme"
      ];
      var currentTheme = document.body.className;
      var currentIndex = themes.indexOf(currentTheme);
      var nextIndex = (currentIndex + 1) % themes.length;
      var nextTheme = themes[nextIndex];
      document.body.className = nextTheme;
      localStorage.setItem("chatTheme", nextTheme);
    };

    function updatePrivateChatList(user1, user2) {
      firebase.database().ref("privateChats/" + user1 + "/" + user2).set(true);
      firebase.database().ref("privateChats/" + user2 + "/" + user1).set(true);
    }

    function showEmojiContainer(messageContainer) {
      if (currentEmojiContainer) {
        currentEmojiContainer.style.display = "none";
      }
      var emojiContainer = messageContainer.querySelector(".emoji-container");
      emojiContainer.style.display = "flex";
      currentEmojiContainer = emojiContainer;
      var firstEmoji = emojiContainer.querySelector(".emoji");
      if (firstEmoji) firstEmoji.focus();
    }

    function hideEmojiContainer() {
      if (currentEmojiContainer) {
        currentEmojiContainer.style.display = "none";
        currentEmojiContainer = null;
      }
    }

    function showActionContainer(messageContainer) {
      if (currentActionContainer) {
        currentActionContainer.style.display = "none";
      }
      var actionContainer = messageContainer.querySelector(".action-container");
      actionContainer.style.display = "flex";
      currentActionContainer = actionContainer;
    }

    function hideActionContainer() {
      if (currentActionContainer) {
        currentActionContainer.style.display = "none";
        currentActionContainer = null;
      }
    }

    function addReaction(messageId, emoji) {
      var messageRef = firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId);
      messageRef.update({ reaction: emoji });
      firebase.database().ref("privateChats/" + currentChatType + "/" + username + "/" + messageId).update({ reaction: emoji });
    }

    function deleteMessageForMe(messageId) {
      firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId).remove();
    }

    function deleteMessageForEveryone(messageId) {
      var senderRef = firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId);
      var receiverRef = firebase.database().ref("privateChats/" + currentChatType + "/" + username + "/" + messageId);
      
      senderRef.update({ 
        deleted: true, 
        message: null, 
        mediaUrl: null, 
        mediaType: null 
      });
      receiverRef.update({ 
        deleted: true, 
        message: null, 
        mediaUrl: null, 
        mediaType: null 
      });
    }

    function showDropdown(options, callback) {
      hideDropdown();
      lastFocusedElement = document.activeElement;
      dropdownMenu.innerHTML = "";
      for (var i = 0; i < options.length; i++) {
        var item = document.createElement("div");
        item.className = "dropdown-item";
        item.textContent = options[i];
        item.tabIndex = 14 + i;
        item.onclick = function (index) {
          return function () {
            callback(index);
            hideDropdown();
          };
        }(i);
        dropdownMenu.appendChild(item);
      }
      dropdownMenu.style.display = "block";
      isDropdownVisible = true;
      dropdownMenu.children[0].focus();
    }

    function hideDropdown() {
      dropdownMenu.style.display = "none";
      isDropdownVisible = false;
      dropdownMenu.innerHTML = "";
      if (lastFocusedElement) lastFocusedElement.focus();
    }

    function navigate(offset) {
      var elements = Array.from(document.querySelectorAll(".navItem, .message, .emoji, .action-button, .dropdown-item"));
      var index = elements.indexOf(document.activeElement);
      var target = elements[index + offset];
      if (target) target.focus();
    }

    document.addEventListener("keydown", function (e) {
      if (isAlertActive) {
        var alertBox = document.querySelector(".custom-alert");
        if (alertBox) {
          var input = alertBox.querySelector("#promptInput");
          var okButton = alertBox.querySelector("#promptOkButton") || alertBox.querySelector("#alertOkButton");
          var cancelButton = alertBox.querySelector("#confirmCancelButton");
          if (input && e.key === "ArrowDown" && document.activeElement === input) {
            okButton.focus();
          } else if (okButton && e.key === "ArrowUp" && document.activeElement === okButton) {
            if (input) input.focus();
          } else if (cancelButton && e.key === "ArrowRight" && document.activeElement === okButton) {
            cancelButton.focus();
          } else if (cancelButton && e.key === "ArrowLeft" && document.activeElement === cancelButton) {
            okButton.focus();
          }
        }
        return;
      }

      var activeElement = document.activeElement;

      if (isDropdownVisible) {
        if (e.key === "ArrowUp") {
          var items = Array.from(dropdownMenu.children);
          var index = items.indexOf(activeElement);
          if (index > 0) items[index - 1].focus();
        } else if (e.key === "ArrowDown") {
          var items = Array.from(dropdownMenu.children);
          var index = items.indexOf(activeElement);
          if (index < items.length - 1) items[index + 1].focus();
        } else if (e.key === "Enter") {
          activeElement.click();
        } else if (e.key === "SoftLeft") {
          hideDropdown();
        }
        return;
      }

      if (activeElement.tagName === "IMG" && activeElement.style.position === "fixed") {
        if (e.key === "Enter" || e.key === "SoftRight") {
          toggleFullScreen(activeElement);
          var messageContainer = activeElement.parentElement.parentElement;
          messageContainer.querySelector(".message").focus();
        }
        return;
      }

      if (activeElement.tagName === "VIDEO" && activeElement.style.position === "fixed") {
        if (e.key === "Enter") {
          if (activeElement.paused) {
            toggleFullScreen(activeElement); // This will handle the play logic
          } else {
            activeElement.pause();
          }
        } else if (e.key === "SoftRight") {
          toggleFullScreen(activeElement);
          var messageContainer = activeElement.parentElement.parentElement;
          messageContainer.querySelector(".message").focus();
        }
        return;
      }

      if (e.key === "SoftLeft") {
        if (isDropdownVisible) {
          hideDropdown();
          return;
        }

        if (mainPage.classList.contains("active") && activeElement.className === "user navItem") {
          var partnerName = activeElement.querySelector("span").textContent;
          showDropdown(["Block", "Delete"], function (index) {
            if (index === 0) {
              blockUser(username, partnerName);
              activeElement.remove();
              showCustomAlert(partnerName + " has been blocked and chat history deleted.", function () {
                document.getElementById("searchInput").focus();
              });
            } else if (index === 1) {
              firebase.database().ref("privateChats/" + username + "/" + partnerName).remove();
              activeElement.remove();
            }
          });
        } else if (chatPage.classList.contains("active") && activeElement.className.indexOf("message") !== -1) {
          var messageContainer = activeElement.parentElement;
          var messageId = activeElement.id.replace("msg-", "");
          var options = ["Reply", "Delete for Me"];
          if (messageContainer.querySelector(".sent")) {
            options.push("Delete for Everyone");
          }
          if (messageContainer.querySelector("img")) {
            options.push("Fullscreen");
            options.push("React");
          } else if (messageContainer.querySelector("video")) {
            getVideoFromIndexedDB(messageId).then(localVideoData => {
              if (localVideoData) {
                options.push("Play");
              } else {
                options.push("Download");
              }
              options.push("Fullscreen");
              options.push("React");
            });
          } else {
            options.push("React");
          }
          showDropdown(options, function (index) {
            var messagesList = Array.from(document.querySelectorAll(".message-container"));
            var currentIndex = messagesList.indexOf(messageContainer);
            var nextMessage = (currentIndex < messagesList.length - 1) ? messagesList[currentIndex + 1].querySelector(".message") : null;
            var prevMessage = (currentIndex > 0) ? messagesList[currentIndex - 1].querySelector(".message") : null;

            if (options[index] === "Delete for Me") {
              deleteMessageForMe(messageId);
              messageContainer.remove();
              if (nextMessage) nextMessage.focus();
              else if (prevMessage) prevMessage.focus();
              else document.getElementById("messageInput").focus();
            } else if (options[index] === "Delete for Everyone") {
              deleteMessageForEveryone(messageId);
              if (nextMessage) nextMessage.focus();
              else if (prevMessage) prevMessage.focus();
              else document.getElementById("messageInput").focus();
            } else if (options[index] === "Fullscreen") {
              var media = messageContainer.querySelector("img") || messageContainer.querySelector("video");
              if (media) toggleFullScreen(media);
            } else if (options[index] === "React") {
              showEmojiContainer(messageContainer);
            } else if (options[index] === "Reply") {
              replyingToMessageId = messageId;
              firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId).once("value", function(snap) {
                var data = snap.val();
                replyInputPreview.style.display = "block";
                replyInputPreview.innerHTML = "Replying to: " + (data.message ? data.message.substring(0, 20) + "..." : (data.mediaType === "image" ? "Image" : "Video"));
                messageInput.focus();
              });
            } else if (options[index] === "Download") {
              firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId).once("value", function(snap) {
                var data = snap.val();
                downloadVideo(data.mediaUrl, messageId, function(localData) {
                  var video = messageContainer.querySelector("video");
                  video.src = localData;
                  console.log("Video src set after download for messageId:", messageId);
                  toggleFullScreen(video);
                });
              });
            } else if (options[index] === "Play") {
              var video = messageContainer.querySelector("video");
              getVideoFromIndexedDB(messageId).then(localVideoData => {
                if (localVideoData) {
                  video.src = localVideoData;
                  console.log("Playing video from IndexedDB for messageId:", messageId);
                  toggleFullScreen(video);
                }
              });
            }
          });
        }
      }

      if (e.key === "Enter") {
        if (activeElement.className === "emoji") {
          var messageContainer = activeElement.parentElement.parentElement;
          var messageId = messageContainer.querySelector(".message").id.replace("msg-", "");
          addReaction(messageId, activeElement.textContent);
          hideEmojiContainer();
          hideActionContainer();
          messageContainer.querySelector(".message").focus();
        } else if (activeElement.className.indexOf("action-button") !== -1) {
          var messageContainer = activeElement.parentElement.parentElement;
          var messageId = messageContainer.querySelector(".message").id.replace("msg-", "");
          var messagesList = Array.from(document.querySelectorAll(".message-container"));
          var currentIndex = messagesList.indexOf(messageContainer);
          var nextMessage = (currentIndex < messagesList.length - 1) ? messagesList[currentIndex + 1].querySelector(".message") : null;
          var prevMessage = (currentIndex > 0) ? messagesList[currentIndex - 1].querySelector(".message") : null;

          if (activeElement.textContent === "Delete for Me") {
            deleteMessageForMe(messageId);
            messageContainer.remove();
            hideEmojiContainer();
            hideActionContainer();
            if (nextMessage) nextMessage.focus();
            else if (prevMessage) prevMessage.focus();
            else document.getElementById("messageInput").focus();
          } else if (activeElement.textContent === "Delete for Everyone") {
            deleteMessageForEveryone(messageId);
            hideEmojiContainer();
            hideActionContainer();
            if (nextMessage) nextMessage.focus();
            else if (prevMessage) prevMessage.focus();
            else document.getElementById("messageInput").focus();
          } else if (activeElement.textContent === "Fullscreen") {
            var media = messageContainer.querySelector("img") || messageContainer.querySelector("video");
            if (media) toggleFullScreen(media);
            hideEmojiContainer();
            hideActionContainer();
          } else if (activeElement.textContent === "Reply") {
            replyingToMessageId = messageId;
            firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId).once("value", function(snap) {
              var data = snap.val();
              replyInputPreview.style.display = "block";
              replyInputPreview.innerHTML = "Replying to: " + (data.message ? data.message.substring(0, 20) + "..." : (data.mediaType === "image" ? "Image" : "Video"));
              messageInput.focus();
            });
            hideEmojiContainer();
            hideActionContainer();
          }
        } else if (activeElement.className.indexOf("message") !== -1) {
          var messageContainer = activeElement.parentElement;
          if (messageContainer.querySelector("img")) {
            var img = messageContainer.querySelector("img");
            toggleFullScreen(img);
          } else if (messageContainer.querySelector("video")) {
            var video = messageContainer.querySelector("video");
            var messageId = activeElement.id.replace("msg-", "");
            getVideoFromIndexedDB(messageId).then(localVideoData => {
              if (localVideoData) {
                video.src = localVideoData;
                console.log("Playing video from IndexedDB on Enter for messageId:", messageId);
                toggleFullScreen(video);
              } else {
                firebase.database().ref("privateChats/" + username + "/" + currentChatType + "/" + messageId).once("value", function(snap) {
                  var data = snap.val();
                  downloadVideo(data.mediaUrl, messageId, function(localData) {
                    video.src = localData;
                    console.log("Video src set after download on Enter for messageId:", messageId);
                    toggleFullScreen(video);
                  });
                });
              }
            });
          } else {
            showEmojiContainer(messageContainer);
          }
        }
      }

      if (e.key === "ArrowDown") {
        var messagesList = Array.from(document.querySelectorAll(".message"));
        var index = messagesList.indexOf(activeElement);
        if (index !== -1 && index < messagesList.length - 1) {
          messagesList[index + 1].focus();
        } else {
          navigate(1);
        }
      }

      if (e.key === "ArrowUp") {
        var messagesList = Array.from(document.querySelectorAll(".message"));
        var index = messagesList.indexOf(activeElement);
        if (index > 0) {
          messagesList[index - 1].focus();
        } else {
          navigate(-1);
        }
      }

      if (e.key === "SoftRight") {
        if (chatPage.classList.contains("active")) {
          chatPage.classList.remove("active");
          mainPage.classList.add("active");
          softKeysContainer.style.display = "block";
          softkeyLeft.innerHTML = "";
          softkeyRight.innerHTML = "Back";
          document.getElementById("searchInput").focus();
          if (chatRef) chatRef.off();
          if (otherChatRef) otherChatRef.off();
          setTypingStatus(username, false);
          currentOpenChat = null;
          firebase.database().ref("presence/" + username).update({ currentChat: null });
          messageInput.placeholder = "Enter your message";
        }
      }

      if (e.key === "5") {
        pressCount++;
        if (pressCount === 1) {
          var lastMessage = messages[messages.length - 1];
          if (lastMessage) lastMessage.element.querySelector(".message").focus();
        } else if (pressCount === 2) {
          sendButton.focus();
          pressCount = 0;
        }
      }
      if (e.key === "8") chatBox.scrollTop += 50;
      if (e.key === "2") chatBox.scrollTop -= 50;
    });
  </script>
  </body>
  </html>
